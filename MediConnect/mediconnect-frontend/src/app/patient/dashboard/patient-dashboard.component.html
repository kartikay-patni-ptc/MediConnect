<p-toast></p-toast>
<div class="min-h-screen flex bg-gray-50">
  <!-- Sidebar -->
  <aside class="bg-white border-r border-gray-200 w-72 shrink-0 hidden lg:flex lg:flex-col">
    <div class="p-4 flex items-center gap-3 border-b border-gray-200">
      <p-avatar label="PA" shape="circle" styleClass="bg-indigo-500 text-white"></p-avatar>
      <div>
        <div class="font-semibold">{{ patient?.firstName || 'Patient' }}</div>
        <div class="text-sm text-gray-500">Dashboard</div>
      </div>
    </div>
    <nav class="p-3 space-y-1">
      <button class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700" routerLink="/patient/dashboard"><i class="pi pi-home"></i><span class="font-medium">Dashboard</span></button>
      <button class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700" routerLink="/prescription/list"><i class="pi pi-file-edit"></i><span class="font-medium">My Prescriptions</span></button>
      <button class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700" routerLink="/patient/history"><i class="pi pi-history"></i><span class="font-medium">Medical History</span></button>
      <button class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700" routerLink="/patient/profile"><i class="pi pi-user"></i><span class="font-medium">Profile</span></button>
      <button class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700" routerLink="/chat"><i class="pi pi-comments"></i><span class="font-medium">AI Consult</span></button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 min-w-0">
    <p-toolbar styleClass="px-4 lg:px-6 py-3 bg-white border-b border-gray-200 sticky top-0 z-10">
      <div class="p-toolbar-group-start flex items-center gap-3">
        <p-breadcrumb [model]="[]" [home]="{icon: 'pi pi-home', routerLink: '/patient/dashboard'}" styleClass="hidden sm:block"></p-breadcrumb>
      </div>
      <div class="p-toolbar-group-end flex items-center gap-2">
        <button pButton icon="pi pi-user-edit" class="p-button-text" (click)="editProfile()" pTooltip="Edit Profile"></button>
        <button pButton icon="pi pi-sign-out" class="p-button-danger p-button-outlined p-button-sm" (click)="logout()" pTooltip="Logout"></button>
        <p-avatar label="PA" shape="circle"></p-avatar>
      </div>
    </p-toolbar>

    <div class="p-4 lg:p-6">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Greeting Card -->
        <div class="rounded-lg shadow-sm bg-gradient-to-r from-indigo-50 to-sky-50 p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-semibold">Hello, {{ patient?.firstName || 'there' }} ðŸ‘‹</div>
              <div class="text-gray-600 mt-1">Hereâ€™s a quick overview of your health.</div>
            </div>
            <i class="pi pi-heart text-4xl text-indigo-400 greet-icon"></i>
          </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-grid">
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Appointments</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold">{{ (prescriptions.length || 0) + 0 }}</div>
              <div class="text-gray-500">upcoming</div>
            </ng-template>
          </p-card>
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Medications</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold">{{ prescriptions.length || 0 }}</div>
              <div class="text-gray-500">recent prescriptions</div>
            </ng-template>
          </p-card>
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Allergies</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold">â€”</div>
              <div class="text-gray-500">reported</div>
            </ng-template>
          </p-card>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <div class="space-y-6 xl:col-span-2">
            <!-- Recent Prescriptions (existing table) -->
    <!-- Patient Profile Card -->
    <div class="col-12 lg:col-4">
      <p-card header="My Profile" styleClass="shadow-2 h-full">
        <div *ngIf="patient; else noProfile" class="space-y-3">
          <div class="flex align-items-center gap-3">
            <i class="pi pi-user text-4xl text-primary"></i>
            <div>
              <h3 class="text-xl font-semibold">{{ patient.firstName }} {{ patient.lastName }}</h3>
              <p class="text-600">{{ patient.email }}</p>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-content-between">
              <span class="font-medium">Phone:</span>
              <span>{{ patient.phoneNumber }}</span>
            </div>
            <div class="flex justify-content-between">
              <span class="font-medium">Gender:</span>
              <span>{{ patient.gender }}</span>
            </div>
            <div class="flex justify-content-between">
              <span class="font-medium">Age:</span>
              <span>{{ patient.dateOfBirth | date:'yyyy-MM-dd' }}</span>
            </div>
          </div>
        </div>
        <ng-template #noProfile>
          <div class="text-center py-4">
            <i class="pi pi-user text-4xl text-400 mb-3"></i>
            <p class="text-600">Profile not set up</p>
            <p-button label="Setup Profile" (onClick)="editProfile()" class="mt-3"></p-button>
          </div>
        </ng-template>
      </p-card>
    </div>

    <!-- Prescriptions Card -->
    <div class="col-12 lg:col-8">
      <p-card styleClass="shadow-2 h-full">
        <ng-template pTemplate="header">
          <div class="flex justify-content-between align-items-center">
            <span class="text-xl font-semibold">Recent Prescriptions</span>
            <p-button label="View All" 
                      icon="pi pi-external-link" 
                      severity="secondary"
                      size="small"
                      [outlined]="true"
                      routerLink="/prescription/list">
            </p-button>
          </div>
        </ng-template>
        <p-table [value]="prescriptions" [paginator]="true" [rows]="3" 
                 [showCurrentPageReport]="true" responsiveLayout="scroll"
                 currentPageReportTemplate="Showing {first} to {last} of {totalRecords} prescriptions">
          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>Doctor</th>
              <th>Diagnosis</th>
              <th>Medications</th>
              <th>Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-prescription>
            <tr>
              <td>{{ prescription.issuedDate | date:'shortDate' }}</td>
              <td>Dr. {{ prescription.doctor?.firstName }} {{ prescription.doctor?.lastName }}</td>
              <td>{{ prescription.diagnosis }}</td>
              <td>
                <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                  {{ prescription.medicines?.length || 0 }} medicines
                </span>
              </td>
              <td>
                <div class="flex gap-1">
                  <p-button icon="pi pi-eye" 
                            severity="info" 
                            size="small"
                            (onClick)="viewPrescription(prescription)"
                            pTooltip="View Details"></p-button>
                  <p-button icon="pi pi-download" 
                            severity="secondary" 
                            size="small"
                            (onClick)="downloadPrescription(prescription)"
                            [disabled]="!prescription.prescriptionImageUrl"
                            pTooltip="Download File"></p-button>
                  <p-button icon="pi pi-shopping-cart" 
                            severity="success" 
                            size="small"
                            (onClick)="orderMedicines(prescription)"
                            [disabled]="prescription.status !== 'ACTIVE'"
                            pTooltip="Order Medicines"></p-button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

            <!-- Doctor Search Section -->
            <div class="col-12">
      <p-card header="Find Doctors" styleClass="shadow-2">
        <div class="mb-4">
          <div class="flex gap-3 align-items-center">
            <span class="p-input-icon-left flex-1">
              <i class="pi pi-search"></i>
              <input pInputText type="text" 
                     [(ngModel)]="searchTerm" 
                     (input)="searchDoctors()"
                     placeholder="Search doctors by specialization or name..." 
                     class="w-full"
                     [disabled]="isLoading">
            </span>
            <p-button *ngIf="searchTerm && searchTerm.trim()" 
                      icon="pi pi-times" 
                      severity="secondary" 
                      (onClick)="clearSearch()"
                      pTooltip="Clear search">
            </p-button>
            <p-button *ngIf="isLoading" 
                      icon="pi pi-spin pi-spinner" 
                      severity="secondary" 
                      [loading]="true"
                      label="Searching...">
            </p-button>
          </div>
          <small class="text-500 mt-2 block">
            <i class="pi pi-info-circle mr-1"></i>
            Try searching for specializations like: cardiology, neurology, orthopedics, dermatology, pediatrics
          </small>
        </div>

        <div class="grid">
          <div class="col-12 md:col-6 lg:col-4" *ngFor="let doctor of filteredDoctors">
            <p-card styleClass="shadow-1 h-full">
              <ng-template pTemplate="header">
                <div class="text-center py-3">
                  <i class="pi pi-user-md text-4xl text-primary"></i>
                </div>
              </ng-template>
              <ng-template pTemplate="body">
                <div class="text-center space-y-2">
                  <h3 class="text-lg font-semibold">Dr. {{ doctor.firstName }} {{ doctor.lastName }}</h3>
                  <p class="text-primary font-medium">{{ doctor.specialization }}</p>
                  <p class="text-600 text-sm">{{ doctor.experience }} years experience</p>
                  <p class="text-600 text-sm">{{ doctor.hospital }}</p>
                </div>
              </ng-template>
              <ng-template pTemplate="footer">
                <div class="flex gap-2">
                  <p-button label="Book Appointment" 
                            icon="pi pi-calendar-plus"
                            (onClick)="bookAppointment(doctor)"
                            class="flex-1">
                  </p-button>
                </div>
              </ng-template>
            </p-card>
          </div>
        </div>

        <div *ngIf="filteredDoctors.length === 0 && !isLoading" class="text-center py-8">
          <i class="pi pi-search text-4xl text-400 mb-3"></i>
          <p class="text-600" *ngIf="!searchTerm || !searchTerm.trim()">Search for doctors by specialization or name</p>
          <p class="text-600" *ngIf="searchTerm && searchTerm.trim()">No doctors found matching your search criteria</p>
          <p class="text-500 text-sm mt-2">
            Try searching for specializations like: cardiology, neurology, orthopedics, dermatology, pediatrics
          </p>
        </div>
        
        <div *ngIf="isLoading" class="text-center py-8">
          <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
          <p class="text-600">Searching for doctors...</p>
        </div>
      </p-card>
            </div>
          </div>

          <!-- Right Column: Insights & History -->
          <div class="space-y-6">
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">Health Insights</ng-template>
              <ng-template pTemplate="content">
                <app-charts></app-charts>
              </ng-template>
            </p-card>
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">History</ng-template>
              <ng-template pTemplate="content">
                <app-history></app-history>
              </ng-template>
            </p-card>
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">AI Health Assistant</ng-template>
              <ng-template pTemplate="content">
                <div class="text-center space-y-4">
                  <i class="pi pi-comments text-4xl text-primary"></i>
                  <p class="text-gray-600">Get instant health advice and medical guidance from our AI assistant.</p>
                  <p-button label="Start AI Consultation" 
                            icon="pi pi-comments" 
                            routerLink="/chat"
                            class="w-full">
                  </p-button>
                </div>
              </ng-template>
            </p-card>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<app-book-appointment-dialog
  [(visible)]="showBookingDialog"
  [doctor]="selectedDoctor"
  [patientId]="patientId"
  [aiSummary]="aiSummary"
  [doctorSummary]="doctorSummary"
  [patientAdvice]="patientAdvice"
  [prescribedMedicines]="prescribedMedicines"
  [riskLevel]="riskLevel"
  [redFlags]="redFlags"
  [homeRemedies]="homeRemedies"
  [specializationHint]="specializationHint"
  (appointmentBooked)="onAppointmentBooked($event)">
</app-book-appointment-dialog>