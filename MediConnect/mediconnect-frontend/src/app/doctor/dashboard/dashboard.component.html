<p-toast></p-toast>
<div class="min-h-screen flex bg-gray-50">
  <!-- Desktop Sidebar -->
  <aside class="bg-white border-r border-gray-200 w-72 shrink-0 hidden lg:flex lg:flex-col" [class.hidden]="!isSidebarOpen">
    <div class="p-4 flex items-center gap-3 border-b border-gray-200">
      <p-avatar label="DO" shape="circle" styleClass="bg-blue-500 text-white"></p-avatar>
      <div>
        <div class="font-semibold">Dr. {{ currentUser?.firstName || 'Kartikay' }}</div>
        <div class="text-sm text-gray-500">{{ currentUser?.specialization || 'Cardiologist' }}</div>
      </div>
    </div>

    <nav class="p-3 space-y-1">
      <button *ngFor="let n of navItems" (click)="onNavClick(n.id)" class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700">
        <i [class]="n.icon"></i>
        <span class="font-medium">{{ n.label }}</span>
      </button>
    </nav>
  </aside>

  <!-- Mobile Sidebar -->
  <p-sidebar [(visible)]="mobileSidebar" position="left" styleClass="w-80" [modal]="true">
    <div class="p-4 flex items-center gap-3 border-b">
      <p-avatar label="DO" shape="circle" styleClass="bg-blue-500 text-white"></p-avatar>
      <div>
        <div class="font-semibold">Dr. {{ currentUser?.firstName || 'Kartikay' }}</div>
        <div class="text-sm text-gray-500">{{ currentUser?.specialization || 'Cardiologist' }}</div>
      </div>
    </div>
    <nav class="p-3 space-y-1">
      <button *ngFor="let n of navItems" (click)="onNavClick(n.id)" class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-gray-100 text-gray-700">
        <i [class]="n.icon"></i>
        <span class="font-medium">{{ n.label }}</span>
      </button>
    </nav>
  </p-sidebar>

  <!-- Patient Selection Dialog -->
  <app-patient-selection-dialog
    *ngIf="showPatientSelectionDialog"
    (patientSelected)="onPatientSelectedForPrescription($event)"
    (dialogClosed)="onPatientDialogClosed()">
  </app-patient-selection-dialog>

  <!-- Main Content -->
  <main class="flex-1 min-w-0">
    <!-- Top Toolbar -->
    <p-toolbar styleClass="px-4 lg:px-6 py-3 bg-white border-b border-gray-200 sticky top-0 z-10">
      <div class="p-toolbar-group-start flex items-center gap-3">
        <button pButton icon="pi pi-bars" class="p-button-text lg:hidden" (click)="openMobileSidebar()" pTooltip="Menu"></button>
        <p-breadcrumb [model]="breadcrumbItems" [home]="breadcrumbHome" styleClass="hidden sm:block"></p-breadcrumb>
      </div>
      <div class="p-toolbar-group-end flex items-center gap-2">
        <span class="p-input-icon-left mr-2">
          <i class="pi pi-search"></i>
          <input pInputText type="text" placeholder="Search appointments" [(ngModel)]="searchQuery" (input)="onGlobalFilter()" class="w-44 sm:w-64" />
        </span>
        <p-splitButton label="Actions" icon="pi pi-plus" [model]="actionItems"></p-splitButton>
        <button pButton icon="pi pi-bell" class="p-button-text" pTooltip="Notifications"></button>
        <button pButton icon="pi pi-home" class="p-button-outlined p-button-sm" (click)="goToHome()" pTooltip="Go to Home"></button>
        <button pButton icon="pi pi-sign-out" class="p-button-danger p-button-outlined p-button-sm" (click)="logout()" pTooltip="Logout"></button>
        <p-avatar label="DO" shape="circle"></p-avatar>
      </div>
    </p-toolbar>

    <div class="p-4 lg:p-6">
      <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl lg:text-2xl font-semibold">Dashboard</h2>
          <button pButton type="button" class="p-button-text hidden lg:inline-flex" (click)="toggleSidebar()">
  <i class="pi" [ngClass]="isSidebarOpen ? 'pi-times' : 'pi-bars'"></i>
</button>
        </div>

        <!-- Upload Prescription Dialog -->
        <p-dialog header="Upload Prescription" [(visible)]="showUploadDialog" [modal]="true" [style]="{width: '32rem'}">
          <p-fileUpload name="prescriptions[]" mode="advanced" [customUpload]="true" (uploadHandler)="onUpload($event)" chooseLabel="Choose" uploadLabel="Upload" cancelLabel="Cancel" accept=".pdf,.jpg,.jpeg,.png" [maxFileSize]="5000000"></p-fileUpload>
        </p-dialog>

        <!-- Appointment Details Dialog -->
        <p-dialog header="Appointment Details" [(visible)]="showAppointmentDialog" [modal]="true" [style]="{width: '50rem'}" [draggable]="false" [resizable]="false">
          <div *ngIf="selectedAppointment" class="space-y-6">
            <!-- Patient Information -->
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-900 mb-3">Patient Information</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-600">Patient Name</label>
                  <p class="text-gray-900">{{ selectedAppointment.patientName }}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Appointment ID</label>
                  <p class="text-gray-900">{{ selectedAppointment.id }}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Appointment Date & Time</label>
                  <p class="text-gray-900">{{ selectedAppointment.time }}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Status</label>
                  <p-tag [value]="selectedAppointment.status" [severity]="getStatusSeverity(selectedAppointment.status)"></p-tag>
                </div>
              </div>
            </div>

          <!-- AI Summary -->
          <div *ngIf="selectedAppointment.aiSummary || selectedAppointment.patientAdvice || selectedAppointment.doctorSummary" class="bg-yellow-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold text-yellow-900 mb-3">
              <i class="pi pi-robot mr-2"></i>AI Health Assessment
            </h3>
            <div class="space-y-3">
              <!-- Patient Advice -->
              <div *ngIf="selectedAppointment.patientAdvice">
                <label class="text-sm font-medium text-gray-600">Patient Advice</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.patientAdvice }}</p>
              </div>
              
              <!-- Doctor Summary -->
              <div *ngIf="selectedAppointment.doctorSummary">
                <label class="text-sm font-medium text-gray-600">AI Diagnosis Summary</label>
                <div class="text-gray-900 bg-white p-3 rounded border">
                  <pre class="whitespace-pre-wrap text-sm">{{ selectedAppointment.doctorSummary }}</pre>
                </div>
              </div>
              
              <!-- Fallback to old aiSummary format if new fields are not available -->
              <div *ngIf="!selectedAppointment.patientAdvice && selectedAppointment.aiSummary">
                <label class="text-sm font-medium text-gray-600">AI Summary</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.aiSummary }}</p>
              </div>
              
              <!-- Risk Level Badge -->
              <div *ngIf="selectedAppointment.riskLevel || (selectedAppointment.aiSummary && selectedAppointment.aiSummary.riskLevel)">
                <label class="text-sm font-medium text-gray-600">Risk Level</label>
                <div class="risk-level-badge" [ngClass]="'risk-' + (selectedAppointment.riskLevel || (selectedAppointment.aiSummary && selectedAppointment.aiSummary.riskLevel) || 'medium').toLowerCase()">
                  <i class="pi pi-exclamation-triangle mr-1"></i>
                  {{ selectedAppointment.riskLevel || (selectedAppointment.aiSummary && selectedAppointment.aiSummary.riskLevel) }}
                </div>
              </div>
              
              <!-- Red Flags -->
              <div *ngIf="selectedAppointment.redFlags && selectedAppointment.redFlags.length > 0">
                <label class="text-sm font-medium text-red-600">Warning Signs</label>
                <ul class="red-flags-list">
                  <li *ngFor="let flag of selectedAppointment.redFlags" class="red-flag-item">
                    {{ flag }}
                  </li>
                </ul>
              </div>
              
              <!-- Home Remedies -->
              <div *ngIf="selectedAppointment.homeRemedies && selectedAppointment.homeRemedies.length > 0">
                <label class="text-sm font-medium text-green-600">Home Care Recommendations</label>
                <ul class="remedies-list">
                  <li *ngFor="let remedy of selectedAppointment.homeRemedies" class="remedy-item">
                    {{ remedy }}
                  </li>
                </ul>
              </div>
              
              <!-- Specialist Recommendation -->
              <div *ngIf="selectedAppointment.specializationHint || (selectedAppointment.aiSummary && selectedAppointment.aiSummary.specializationHint)">
                <label class="text-sm font-medium text-blue-600">Specialist Recommendation</label>
                <div class="specialist-hint">
                  Consider consulting a <strong>{{ selectedAppointment.specializationHint || (selectedAppointment.aiSummary && selectedAppointment.aiSummary.specializationHint) }} specialist</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- Doctor-Focused Clinical Summary -->
          <div *ngIf="selectedAppointment.doctorSummary" class="bg-blue-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">
              <i class="pi pi-stethoscope mr-2"></i>Doctor-Focused Clinical Summary
            </h3>
            <div class="space-y-3">
              <div *ngIf="selectedAppointment.doctorSummary.chiefComplaint">
                <label class="text-sm font-medium text-gray-600">Chief Complaint</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.chiefComplaint }}</p>
              </div>
              <div *ngIf="selectedAppointment.doctorSummary.historyOfPresentIllness">
                <label class="text-sm font-medium text-gray-600">History of Present Illness</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.historyOfPresentIllness }}</p>
              </div>
              <div *ngIf="selectedAppointment.doctorSummary.medicalHistory">
                <label class="text-sm font-medium text-gray-600">Relevant Medical History</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.medicalHistory }}</p>
              </div>
              <div *ngIf="selectedAppointment.doctorSummary.assessment">
                <label class="text-sm font-medium text-gray-600">Assessment</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.assessment }}</p>
              </div>
              <div *ngIf="selectedAppointment.doctorSummary.plan">
                <label class="text-sm font-medium text-gray-600">Plan</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.plan }}</p>
              </div>
              <div *ngIf="selectedAppointment.doctorSummary.specialistRecommendation">
                <label class="text-sm font-medium text-gray-600">Specialist Recommendation</label>
                <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.doctorSummary.specialistRecommendation }}</p>
              </div>
            </div>
          </div>

          <!-- Prescribed Medicines -->
          <div *ngIf="(selectedAppointment.prescribedMedicines && selectedAppointment.prescribedMedicines.length > 0) || (selectedAppointment.doctorSummary && selectedAppointment.doctorSummary.prescribedMedicines && selectedAppointment.doctorSummary.prescribedMedicines.length > 0)" class="bg-purple-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold text-purple-900 mb-3">
              <i class="pi pi-pills mr-2"></i>Prescribed Medicines
            </h3>
            <div class="medicines-grid">
              <div *ngFor="let med of (selectedAppointment.prescribedMedicines || (selectedAppointment.doctorSummary && selectedAppointment.doctorSummary.prescribedMedicines))" class="medicine-card">
                <div class="medicine-name">{{ med.name }}</div>
                <div class="medicine-details">
                  <span class="dose">{{ med.dose }}</span>
                  <span class="frequency">{{ med.frequency }}</span>
                  <span class="duration">for {{ med.duration }}</span>
                </div>
                <div class="medicine-type" [ngClass]="med.otcOrPrescription.toLowerCase()">
                  {{ med.otcOrPrescription }}
                </div>
              </div>
            </div>
          </div>

            <!-- Patient Notes -->
            <div *ngIf="selectedAppointment.notes" class="bg-yellow-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-yellow-900 mb-3">Patient Notes</h3>
              <p class="text-gray-900 bg-white p-3 rounded border">{{ selectedAppointment.notes }}</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between items-center pt-4 border-t">
              <div class="flex gap-3">
                <button pButton label="Write Prescription" 
                        icon="pi pi-prescription" 
                        class="p-button-primary"
                        (click)="writePrescription(selectedAppointment.id)"
                        [disabled]="selectedAppointment.status === 'Cancelled'"
                        pTooltip="Create prescription for this patient"></button>
              </div>
              <div class="flex gap-3">
                <button pButton label="Cancel Appointment" 
                        icon="pi pi-times" 
                        class="p-button-danger p-button-outlined"
                        (click)="cancelAppointment(selectedAppointment.id)"
                        [disabled]="selectedAppointment.status === 'Cancelled'"></button>
                <button pButton label="Mark Complete" 
                        icon="pi pi-check" 
                        class="p-button-success"
                        (click)="completeAppointment(selectedAppointment.id)"
                        [disabled]="selectedAppointment.status === 'Completed' || selectedAppointment.status === 'Cancelled'"></button>
                <button pButton label="Start Consultation" 
                        icon="pi pi-play" 
                        class="p-button-primary"
                        (click)="startConsultation(selectedAppointment.id)"
                        [disabled]="selectedAppointment.status === 'Completed' || selectedAppointment.status === 'Cancelled'"></button>
              </div>
            </div>
          </div>
        </p-dialog>

        <!-- Gradient Greeting Card -->
        <div class="rounded-lg shadow-sm bg-gradient-to-r from-blue-50 to-indigo-50 p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-semibold">{{ greeting }}</div>
              <div class="text-gray-600 mt-1">Here's a quick overview of your appointments today.</div>
            </div>
            <img src="assets/illustrations/doctor-hero.svg" alt="Doctor" class="h-20 w-auto" />
          </div>
        </div>

        <!-- Stats: Single Row -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Total Appointments</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold text-blue-600">{{ patientStats.totalPatients }}</div>
              <div class="text-gray-500">this month</div>
            </ng-template>
          </p-card>
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Pending</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold text-orange-600">{{ patientStats.awaiting }}</div>
              <div class="text-gray-500">awaiting confirmation</div>
            </ng-template>
          </p-card>
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Today's Appointments</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold text-green-600">{{ patientStats.newThisWeek }}</div>
              <div class="text-gray-500">scheduled</div>
            </ng-template>
          </p-card>
          <p-card class="rounded-lg shadow-sm h-full">
            <ng-template pTemplate="title">Completed</ng-template>
            <ng-template pTemplate="content">
              <div class="text-3xl font-bold text-purple-600">{{ completedAppointments }}</div>
              <div class="text-gray-500">this week</div>
            </ng-template>
          </p-card>
        </div>

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <!-- Left Column: Schedule + Table -->
          <div class="space-y-6 xl:col-span-2">
            <!-- Today's Schedule -->
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">Today's Schedule</ng-template>
              <ng-template pTemplate="content">
                <div class="space-y-2">
                  <div *ngFor="let s of todaySchedule" class="group flex items-center justify-between rounded-md px-3 py-3 hover:bg-gray-50">
                    <div class="flex items-center gap-3">
                      <i class="pi pi-clock text-gray-500"></i>
                      <div>
                        <div class="font-medium">{{ s.time }}</div>
                        <div class="text-gray-500 text-sm">{{ s.patient }}</div>
                      </div>
                    </div>
                    <p-tag [value]="s.type" severity="info"></p-tag>
                  </div>
                </div>
              </ng-template>
            </p-card>

            <!-- Upcoming Appointments Table -->
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">Upcoming Appointments</ng-template>
              <ng-template pTemplate="content">
                <p-table #dataTable [value]="upcomingAppointments" [globalFilterFields]="['id','patientName','time','type','status']" [paginator]="true" [rows]="5" [rowsPerPageOptions]="[5,10]" styleClass="p-datatable-sm p-datatable-striped p-datatable-hover rounded-lg">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Appointment ID</th>
                      <th>Patient</th>
                      <th>Time</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-row>
                    <tr>
                      <td>{{ row.id }}</td>
                      <td class="flex items-center gap-2">
                        <p-avatar icon="pi pi-user" shape="circle"></p-avatar>
                        <span>{{ row.patientName }}</span>
                      </td>
                      <td>{{ row.time }}</td>
                      <td>{{ row.type }}</td>
                      <td>
                        <p-tag [value]="row.status" [severity]="getStatusSeverity(row.status)"></p-tag>
                      </td>
                      <td>
                        <div class="flex gap-2">
                          <button pButton icon="pi pi-eye" 
                                  class="p-button-text p-button-sm" 
                                  (click)="viewAppointmentDetails(row)"
                                  pTooltip="View Details"></button>
                          <button pButton icon="pi pi-check" 
                                  class="p-button-text p-button-sm p-button-success" 
                                  (click)="completeAppointment(row.id)"
                                  [disabled]="row.status === 'Completed' || row.status === 'Cancelled'"
                                  pTooltip="Mark Complete"></button>
                          <button pButton icon="pi pi-times" 
                                  class="p-button-text p-button-sm p-button-danger" 
                                  (click)="cancelAppointment(row.id)"
                                  [disabled]="row.status === 'Cancelled'"
                                  pTooltip="Cancel Appointment"></button>
                        </div>
                      </td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="6">
                        <div class="text-center py-10 text-gray-500">
                          <i class="pi pi-calendar-times text-4xl mb-3 text-gray-300"></i>
                          <p>No appointments found</p>
                          <p class="text-sm">All clear for today!</p>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </ng-template>
            </p-card>
          </div>

          <!-- Right Column: Calendar -->
          <div class="space-y-6">
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">Calendar</ng-template>
              <ng-template pTemplate="content">
                <p-calendar [(ngModel)]="selectedDate" [inline]="true"></p-calendar>
              </ng-template>
            </p-card>

            <!-- Quick Actions -->
            <p-card class="rounded-lg shadow-sm">
              <ng-template pTemplate="title">Quick Actions</ng-template>
              <ng-template pTemplate="content">
                <div class="space-y-3">
                  <button pButton label="My Prescriptions" 
                          icon="pi pi-list" 
                          class="p-button-outlined w-full"
                          (click)="onNavClick('prescriptions')"></button>
                  <button pButton label="View All Appointments" 
                          icon="pi pi-calendar" 
                          class="p-button-outlined w-full"
                          (click)="viewAllAppointments()"></button>
                  <button pButton label="Manage Slots" 
                          icon="pi pi-clock" 
                          class="p-button-outlined w-full"
                          (click)="manageSlots()"></button>
                  <button pButton label="Patient Records" 
                          icon="pi pi-users" 
                          class="p-button-outlined w-full"
                          (click)="viewPatientRecords()"></button>
                </div>
              </ng-template>
            </p-card>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>