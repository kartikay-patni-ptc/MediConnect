<div class="order-management-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm mb-6 p-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          <i class="pi pi-shopping-cart text-primary mr-3"></i>
          Order Management
        </h1>
        <p class="text-gray-600">Manage incoming medicine orders and track their progress</p>
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Refresh" 
          icon="pi pi-refresh"
          severity="secondary"
          [outlined]="true"
          (onClick)="refreshOrders()">
        </p-button>
        <p-button 
          label="Back to Dashboard" 
          icon="pi pi-arrow-left"
          severity="secondary"
          [outlined]="true"
          routerLink="/pharmacist/dashboard">
        </p-button>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
    <p-card styleClass="shadow-sm">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600">{{ totalOrders }}</div>
        <div class="text-sm text-gray-600">Total Orders</div>
      </div>
    </p-card>
    
    <p-card styleClass="shadow-sm">
      <div class="text-center">
        <div class="text-2xl font-bold text-orange-600">{{ pendingOrders }}</div>
        <div class="text-sm text-gray-600">Pending</div>
      </div>
    </p-card>
    
    <p-card styleClass="shadow-sm">
      <div class="text-center">
        <div class="text-2xl font-bold text-yellow-600">{{ acceptedOrders }}</div>
        <div class="text-sm text-gray-600">Accepted</div>
      </div>
    </p-card>
    
    <p-card styleClass="shadow-sm">
      <div class="text-center">
        <div class="text-2xl font-bold text-purple-600">{{ preparingOrders }}</div>
        <div class="text-sm text-gray-600">Preparing</div>
      </div>
    </p-card>
    
    <p-card styleClass="shadow-sm">
      <div class="text-center">
        <div class="text-2xl font-bold text-green-600">{{ readyOrders }}</div>
        <div class="text-sm text-gray-600">Ready</div>
      </div>
    </p-card>
  </div>

  <!-- Filters and Search -->
  <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">Search Orders</label>
        <div class="relative">
          <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            (input)="filterOrders()"
            placeholder="Search by order number, patient name, or address..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>
      
      <div class="w-full md:w-48">
        <label class="block text-sm font-medium text-gray-700 mb-2">Status Filter</label>
        <select 
          [(ngModel)]="statusFilter"
          (change)="filterOrders()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="ALL">All Statuses</option>
          <option value="PENDING">Pending</option>
          <option value="PHARMACY_ASSIGNED">Assigned</option>
          <option value="ACCEPTED">Accepted</option>
          <option value="PREPARING">Preparing</option>
          <option value="READY_FOR_PICKUP">Ready</option>
          <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
          <option value="DELIVERED">Delivered</option>
          <option value="REJECTED">Rejected</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="bg-white rounded-lg shadow-sm">
    <div class="p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Orders ({{ filteredOrders.length }})</h3>
    </div>
    
    <div *ngIf="loading" class="p-8 text-center">
      <p-progressSpinner></p-progressSpinner>
      <p class="mt-4 text-gray-600">Loading orders...</p>
    </div>

    <div *ngIf="!loading && filteredOrders.length === 0" class="p-8 text-center">
      <i class="pi pi-inbox text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No orders found</h3>
      <p class="text-gray-600">
        {{ orders.length === 0 ? 'You don\'t have any orders yet.' : 'No orders match your current filters.' }}
      </p>
    </div>

    <div *ngIf="!loading && filteredOrders.length > 0" class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let order of filteredOrders" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ order.orderNumber }}</div>
                             <div class="text-sm text-gray-500">{{ order.orderItems.length || 0 }} items</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ order.patientName }}</div>
              <div class="text-sm text-gray-500">{{ order.patientPhone }}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900">{{ order.deliveryAddress }}</div>
              <div class="text-sm text-gray-500">Pincode: {{ order.deliveryPincode }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">₹{{ order.finalAmount }}</div>
              <div class="text-sm text-gray-500">+₹{{ order.deliveryFee }} delivery</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                              <span 
                  [class]="'text-xs font-medium px-2 py-1 rounded-full ' + getStatusSeverityClass(order.status)">
                  {{ getStatusLabel(order.status) }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ order.createdAt | date:'short' }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex gap-2">
                <button 
                  pButton 
                  label="View" 
                  icon="pi pi-eye" 
                  class="p-button-sm p-button-outlined"
                  (click)="viewOrderDetails(order)">
                </button>
                
                                 <button 
                   *ngIf="order.status === OrderStatus.PENDING || order.status === OrderStatus.PHARMACY_ASSIGNED"
                   pButton 
                   label="Accept" 
                   icon="pi pi-check" 
                   class="p-button-sm p-button-success"
                   (click)="acceptOrder(order)">
                 </button>
                 
                 <button 
                   *ngIf="order.status === OrderStatus.PENDING || order.status === OrderStatus.PHARMACY_ASSIGNED"
                   pButton 
                   label="Reject" 
                   icon="pi pi-times" 
                   class="p-button-sm p-button-danger"
                   (click)="rejectOrder(order)">
                 </button>
                 
                 <button 
                   *ngIf="order.status === OrderStatus.ACCEPTED"
                   pButton 
                   label="Start Preparing" 
                   icon="pi pi-cog" 
                   class="p-button-sm p-button-warning"
                   (click)="updateOrderStatus(order, OrderStatus.PREPARING)">
                 </button>
                 
                 <button 
                   *ngIf="order.status === OrderStatus.PREPARING"
                   pButton 
                   label="Mark Ready" 
                   icon="pi pi-check-circle" 
                   class="p-button-sm p-button-info"
                   (click)="updateOrderStatus(order, OrderStatus.READY_FOR_PICKUP)">
                 </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Order Details Dialog -->
  <p-dialog 
    [(visible)]="showOrderDialog" 
    [modal]="true" 
    [closable]="true"
    header="Order Details"
    styleClass="w-4xl"
    (onHide)="closeOrderDialog()">
    
    <div *ngIf="selectedOrder" class="p-4">
      <!-- Order Header -->
      <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Order {{ selectedOrder.orderNumber }}</h3>
            <p class="text-sm text-gray-600">Created: {{ selectedOrder.createdAt | date:'full' }}</p>
            <p class="text-sm text-gray-600">Status: 
              <span 
                [class]="'text-xs font-medium px-2 py-1 rounded-full ' + getStatusSeverityClass(selectedOrder.status)">
                {{ getStatusLabel(selectedOrder.status) }}
              </span>
            </p>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-gray-900">₹{{ selectedOrder.finalAmount }}</p>
            <p class="text-sm text-gray-600">Total Amount</p>
            <p class="text-sm text-gray-500">+₹{{ selectedOrder.deliveryFee }} delivery fee</p>
          </div>
        </div>
      </div>

      <!-- Patient Information -->
      <div class="mb-6">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">Patient Information</h4>
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm font-medium text-gray-700">Name</p>
              <p class="text-lg text-gray-900">{{ selectedOrder.patientName }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-700">Phone</p>
              <p class="text-lg text-gray-900">{{ selectedOrder.patientPhone }}</p>
            </div>
          </div>
          <div class="mt-4">
            <p class="text-sm font-medium text-gray-700">Delivery Address</p>
            <p class="text-lg text-gray-900">{{ selectedOrder.deliveryAddress }}</p>
            <p class="text-sm text-gray-600">Pincode: {{ selectedOrder.deliveryPincode }}</p>
          </div>
          <div *ngIf="selectedOrder.specialInstructions" class="mt-4">
            <p class="text-sm font-medium text-gray-700">Special Instructions</p>
            <p class="text-lg text-gray-900">{{ selectedOrder.specialInstructions }}</p>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="mb-6">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">Order Items</h4>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Medicine</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dosage</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr *ngFor="let item of selectedOrder.orderItems">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {{ item.medicineName }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ item.dosage }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ item.quantity }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span 
                    [class]="'text-xs font-medium px-2 py-1 rounded-full ' + getItemStatusSeverityClass(item.status)">
                    {{ item.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button 
          pButton 
          label="Close" 
          icon="pi pi-times" 
          class="p-button-secondary"
          (click)="closeOrderDialog()">
        </button>
      </div>
    </div>
  </p-dialog>

  <!-- Reject Order Dialog -->
  <p-dialog 
    [(visible)]="showRejectDialog" 
    [modal]="true" 
    [closable]="true"
    header="Reject Order"
    styleClass="w-2xl"
    (onHide)="closeRejectDialog()">
    
    <div class="p-4">
      <form [formGroup]="rejectForm" (ngSubmit)="submitRejection()">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
          <textarea 
            formControlName="rejectionReason"
            rows="4"
            placeholder="Please provide a detailed reason for rejecting this order..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </textarea>
          <div *ngIf="rejectForm.get('rejectionReason')?.invalid && rejectForm.get('rejectionReason')?.touched" class="mt-1 text-sm text-red-600">
            <span *ngIf="rejectForm.get('rejectionReason')?.errors?.['required']">Rejection reason is required.</span>
            <span *ngIf="rejectForm.get('rejectionReason')?.errors?.['minlength']">Rejection reason must be at least 10 characters.</span>
          </div>
        </div>
        
        <div class="flex justify-end gap-3">
          <button 
            type="button"
            pButton 
            label="Cancel" 
            icon="pi pi-times" 
            class="p-button-secondary"
            (click)="closeRejectDialog()">
          </button>
          <button 
            type="submit"
            pButton 
            label="Reject Order" 
            icon="pi pi-times" 
            class="p-button-danger"
            [disabled]="rejectForm.invalid">
          </button>
        </div>
      </form>
    </div>
  </p-dialog>
</div>
